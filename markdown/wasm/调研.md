### webassembly 概念

`WebAssembly`是一种运行在现代网络浏览器中的新型代码，并且提供新的性能特性和效果。它设计的目的不是为了手写代码而是为诸如C、C++和Rust等低级源语言提供一个高效的编译目标。什么是编译目标？当我们写 TypeScript 的时候，Webpack 最后打包生成的 JavaScript 文件就是编译目标。也就是说，你不需要直接写 WebAssembly 代码，而是从其他高级语言编译过来就行。

### webassembly 有什么优点

1. 快速、高效

WebAssembly 的二进制文件比 JavaScript 文本文件小得多，因而下载速度更快。其解析和执行速度也更快。对比 JavaScript，JavaScript 是一种动态类型语言，不必事先定义变量类型，也不需要提前编译。这使得代码编写变得简单快捷，但这也意味着 JavaScript 引擎有大量的额外工作。 JavaScript 引擎在运行 JavaScript 代码的时候，必须解析，编译并优化代码。而 WebAssembly 本身就以二进制形式提供，解析速度更快，且它是静态类型的，其引擎在编译期间不需要类型推断，也没有垃圾收集等。WebAssembly代码在不同平台上能够以接近本地速度运行。

js 和 webassembly 的执行过程对比：
// TODO 图片
WebAssembly 执行快更详细的原因可以看这里：https://zhuanlan.zhihu.com/p/422541443

2. 可移植、灵活

使用 WebAssembly ，只需要一次编译，您的应用程序将可以在每个现代浏览器中运行。使用“原生”模块也就没那么复杂，如果开发人员可以跨不同平台 (例如，在 Web 和桌面应用程序) 共享同一脚本语言或低级语言代码库，则可以节省开发时间并降低维护成本。而WebAssembly 为你提供了一种在不降低这些平台性能的前提下实现此目标的方法。

3. 安全

WebAssembly 默认为你提供轻量级沙箱，像其他网络代码一样，它遵循浏览器的同源策略和授权策略。

### 调研目标

1. webp图片的优势在于它具有更优的图像数据压缩算法，在拥有肉眼无法识别差异的图像质量前提下，带来更小的图片体积。但是在支持性上，如图：
// TODO 图片
ios 系统只有版本在14以上才支持，安卓基本都支持。因此，我们想用它的时候，只能采取降级方案。那么有没有办法在系统不支持webp的情况下渲染webp图片呢
2. 视频上传问题
  2.1 封面出来慢
  2.2 非标准视频截不出图片
  2.3 视频上传慢
  2.4 视频转码上传
3. 
### 结论

#### 支持webp图片渲染

可基于 WebAssembly 支持 webp 格式的图片渲染，且实现方案比较成熟。
1. 微信官方小程序在基础库版本大于 2.9.0 时已支持 webp 格式的图片渲染。不过官方不是基于 WebAssembly 的。

虽然WebAssembly的解码性能比JavaScript快不少，但遇到超大分辨率（如1920 x 1080等）的webP时，却远远落后于客户端的解码性能。综合对比各种方案的性能和兼容性之后，而是采用了基于iOS客户端自定义协议webphttps的方案，大致步骤如下：

+ 首先，微信小程序基础库判断开发者在image组件使用的是webP格式时，则在image src里加上webp头部如：webphttps://example.png。

+ 然后，客户端通过NSURLProtocol协议挟持webphttps的请求，并下载相应的webP数据进行解码。

+ 最后，再把解码后的image数据回吐给浏览器进行渲染显示。

基于 WebAssembly 的实现原理可参考：https://juejin.cn/post/6844903893759950855
2. 电脑端打开小程序，暂不支持 webp 格式的图片渲染（电脑端打开，本身网络环境相对更好。或推动客户端支持）
3. 对于h5页面，也有比较成熟的基于 WebAssembly 支持 webp 格式的图片渲染的方案，参考：https://zhuanlan.zhihu.com/p/182507828

#### 视频上传

### 现存方案对比
1. 基于 WebP 的图片高性能加载方案：https://zhuanlan.zhihu.com/p/182507828
2. 

### 参考文档链接
+ https://developer.mozilla.org/zh-CN/docs/WebAssembly/Concepts
+ [webassembly基础与应用](http://quickapp.vivo.com.cn/webassembly/#toc-0)
+ https://www.infoq.cn/article/lwlcldgjyc7lye95ewl8
+ https://zhuanlan.zhihu.com/p/42718990